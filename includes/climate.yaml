# ============================================================================
# CLIMATE (THERMOSTAT) COMPONENT
# ============================================================================
# ESPHome thermostat component for Home Assistant integration
# This component provides the climate entity that Home Assistant expects
# It works in conjunction with the manage_heating script which implements
# the priority-based heating control

climate:
  - platform: thermostat
    name: "Propane Stove Thermostat"
    id: gazebo_thermostat
    icon: "mdi:fire"

    # ========================================================================
    # SENSOR CONFIGURATION
    # ========================================================================
    # The temperature sensor this thermostat monitors
    sensor: gazebo_temp

    # ========================================================================
    # PRESET MODES - Temperature Ranges
    # ========================================================================
    # ESPHome 2025.10.3 requires presets for all temperature setpoints
    # First preset becomes the default on boot
    preset:
      - name: Home
        default_target_temperature_low: 20
      - name: Comfort
        default_target_temperature_low: 22
      - name: Away
        default_target_temperature_low: 15
      - name: Sleep
        default_target_temperature_low: 16

    # ========================================================================
    # HEATING CONTROL CONFIGURATION
    # ========================================================================
    # Minimum time the heating must stay ON when activated
    min_heating_run_time: 60s

    # Minimum time the heating must stay OFF before turning on again
    min_heating_off_time: 60s

    # Minimum time the system must be idle before considering to heat again
    min_idle_time: 60s

    # Hysteresis (deadband) settings
    # Note: Set to minimum (1째C) so thermostat triggers heat_action frequently.
    # The actual hysteresis is controlled by the heating_hysteresis slider
    # and applied in manage_heating script. The thermostat's "action" display
    # may not match the actual relay state when slider > 1째C.
    heat_deadband: 1.0  # Minimum - actual control via manage_heating
    heat_overrun: 1.0   # Minimum - actual control via manage_heating

    # ========================================================================
    # HEATING ACTION
    # ========================================================================
    # NOTE: These actions call the manage_heating script, which implements
    # the priority-based control logic (Force Off > Emergency Heat > Schedule > Thermostat)
    # The manage_heating script reads from this climate component's state
    # and applies priority-based control before actually toggling the relay.

    heat_action:
      # When climate thinks heating should turn ON, trigger heating evaluation
      - script.execute: manage_heating
      # Update Nextion Page 3 with setpoint
      - lambda: |-
          if (id(gazebo_nextion).is_failed() == false) {
            float target = id(gazebo_thermostat).target_temperature;
            // n0: desired temperature (left side)
            id(gazebo_nextion).send_command_printf("n0.val=%d", (int)target);
            // Slider0: map 15-30째C to 0-100
            int slider_val = (int)(((target - 15.0) / 15.0) * 100.0);
            if (slider_val < 0) slider_val = 0;
            if (slider_val > 100) slider_val = 100;
            id(gazebo_nextion).send_command_printf("Slider0.val=%d", slider_val);
            ESP_LOGD("NEXTION_DEBUG", "Updated n0=%d, Slider0=%d", (int)target, slider_val);
          }

    idle_action:
      # When climate thinks heating should turn OFF, trigger heating evaluation
      - script.execute: manage_heating
      # Update Nextion Page 3 with setpoint
      - lambda: |-
          if (id(gazebo_nextion).is_failed() == false) {
            float target = id(gazebo_thermostat).target_temperature;
            // n0: desired temperature (left side)
            id(gazebo_nextion).send_command_printf("n0.val=%d", (int)target);
            // Slider0: map 15-30째C to 0-100
            int slider_val = (int)(((target - 15.0) / 15.0) * 100.0);
            if (slider_val < 0) slider_val = 0;
            if (slider_val > 100) slider_val = 100;
            id(gazebo_nextion).send_command_printf("Slider0.val=%d", slider_val);
            ESP_LOGD("NEXTION_DEBUG", "Updated n0=%d, Slider0=%d", (int)target, slider_val);
          }

    # ========================================================================
    # IMPLEMENTATION NOTES
    # ========================================================================
    # The thermostat climate component provides:
    # 1. Climate entity for Home Assistant dashboard
    # 2. Target temperature setpoint control
    # 3. Automatic hysteresis-based heating decisions
    # 4. Minimum run/off time enforcement (prevents rapid cycling)
    # 5. Integration with Home Assistant climate automations
    #
    # The manage_heating script provides:
    # 1. Priority-based control hierarchy:
    #    - Priority 1: Force Off (Manual Stop) - absolute shutdown
    #    - Priority 2: Emergency Heat (Manual Run) - 15-minute override
    #    - Priority 3: Schedule (Presence Mode) - home/away control
    #    - Priority 4: Thermostat Algorithm - normal operation
    # 2. Override logic that respects user safety priorities
    # 3. Detailed logging for debugging and monitoring
    #
    # Combined behavior:
    # When climate component decides heating should change state, it calls
    # manage_heating script. The script then applies all priority logic and
    # actuator state to decide whether to actually control the relay.
    #
    # This ensures safety (Force Off always works) while providing automatic
    # temperature control through the climate component's algorithms.
