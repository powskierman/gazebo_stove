# ============================================================================
# CLIMATE (PID THERMOSTAT) COMPONENT
# ============================================================================
# ESPHome PID climate component for propane stove heating control
# All control logic runs on ESP32 - works even if Home Assistant is unavailable

# ============================================================================
# SLOW PWM OUTPUT - Converts PID 0-100% to relay ON/OFF cycles
# ============================================================================
output:
  - platform: slow_pwm
    id: heater_pwm
    pin: GPIO12
    period: 120s  # 2-minute cycle period for propane stove
    turn_on_action:
      then:
        - lambda: 'id(heater_output_level) = 1.0;'
        - light.turn_on: status_light
    turn_off_action:
      then:
        - lambda: 'id(heater_output_level) = 0.0;'
        - light.turn_off: status_light

  # Dummy cool output for PID autotuning (does nothing - we only heat)
  - platform: template
    id: dummy_cool
    type: float
    write_action:
      - lambda: |-
          // Dummy output - cooling not available for propane stove
          ESP_LOGD("COOL", "Cool output requested (ignored): %.1f%%", state * 100);

# ============================================================================
# PID CLIMATE CONTROLLER
# ============================================================================
climate:
  - platform: pid
    id: gazebo_thermostat
    name: "Gazebo Stove"
    sensor: gazebo_temp
    default_target_temperature: 20
    heat_output: heater_pwm
    cool_output: dummy_cool  # Dummy for autotuning - enables AUTO mode
    
    # PID Control Parameters
    # Conservative values for propane stove heating
    # Tune later with autotune when actual heater is connected
    control_parameters:
      kp: 5.0      # Proportional - moderate response to error
      ki: 0.003    # Integral - slow accumulation to fix steady-state error
      kd: 100.0    # Derivative - dampen oscillation, prevent overshoot
      output_averaging_samples: 5  # Smooth output
    
    # Deadband for stability - prevents oscillation near setpoint
    deadband_parameters:
      threshold_high: 1.0째C   # Don't reduce heat until 1째C above target
      threshold_low: -1.0째C   # Don't increase heat until 1째C below target
      kp_multiplier: 0.0      # No proportional response in deadband
      ki_multiplier: 0.05     # Slow integral accumulation (5%)
      kd_multiplier: 0.0      # No derivative in deadband
      deadband_output_averaging_samples: 15  # Extra smoothing in deadband
    
    # Visual settings
    visual:
      min_temperature: 5
      max_temperature: 35
      temperature_step: 0.5
# ============================================================================
# IMPLEMENTATION NOTES
# ============================================================================
# The PID climate controller provides:
# 1. Proportional-Integral-Derivative temperature control
# 2. Slow PWM output for binary relay (2-minute cycle)
# 3. Deadband to prevent rapid cycling near setpoint
# 4. Smooth output averaging for stable operation
#
# Priority overrides (Force Off, Emergency Heat, Schedule) are handled
# by the manage_heating script in automation.yaml which can override
# the PID controller when needed.
#
# AUTOTUNE PROCESS:
# 1. Use the "PID Autotune" button to start autotuning
# 2. Wait for oscillation cycles (can take 1-2 hours)
# 3. Copy kp, ki, kd values from logs to this file
# 4. Re-upload firmware with tuned values
#
# Note: The heater_output_level global is updated by slow_pwm on/off actions
# to track the current state for the priority override system.
