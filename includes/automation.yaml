# ============================================================================
# AUTOMATION & CONTROL LOGIC
# ============================================================================
# Scripts for heating control, display initialization, and system management

script:
  # Initialize Nextion display on boot
  - id: init_nextion
    then:
      - logger.log: "Initializing Nextion display..."
      - lambda: |-
          if (id(gazebo_nextion).is_failed() == false) {
            id(gazebo_nextion).send_command("cls 0x0000");
            ESP_LOGI("NEXTION_INIT", "Display cleared");

            // Update Page 0 with initial values
            id(gazebo_nextion).send_command_printf("temp.val=%d", (int)id(gazebo_temp).state);
            id(gazebo_nextion).send_command_printf("n0.val=%d", (int)id(gazebo_temp).state);
            id(gazebo_nextion).send_command_printf("n1.val=%d", (int)id(desired_temp).state);

            ESP_LOGI("NEXTION_INIT", "Display initialization complete");
          } else {
            ESP_LOGE("NEXTION_INIT", "Nextion display failed - cannot initialize");
          }

  # Manage heating with priority logic (overrides thermostat)
  # Priority: Force Off (Manual Stop) > Emergency Heat (Manual Run) > Schedule (Away Mode) > Thermostat
  # This script only handles priority overrides - normal temperature control is done by the thermostat
  - id: manage_heating
    then:
      - lambda: |-
          bool away_mode = (id(presence_mode).state == "away");
          bool manual_stop = id(manual_stop_active);
          bool manual_run = id(manual_run_active);

          ESP_LOGD("PRIORITY", "Away=%s, ManualStop=%s, ManualRun=%s",
                   away_mode ? "true" : "false",
                   manual_stop ? "true" : "false",
                   manual_run ? "true" : "false");

          // Priority 1: Force Off (Manual Stop) - HIGHEST PRIORITY
          if (manual_stop) {
            if (id(relay).state) {
              id(relay).turn_off();
              ESP_LOGI("PRIORITY", "Force Off: Relay OFF (priority 1)");
            }
            return;
          }

          // Priority 2: Emergency Heat (Manual Run)
          if (manual_run) {
            long elapsed = millis() - id(manual_run_timeout);
            long timeout_ms = 15 * 60 * 1000; // 15 minutes in milliseconds

            if (elapsed >= timeout_ms) {
              // Auto-disable after 15 minutes
              ESP_LOGI("MANUAL_RUN", "15-minute timeout reached - auto-disabling");
              id(manual_run_active) = false;
              // Continue to lower priorities after manual run expires
            } else {
              // Keep relay ON while manual run is active
              if (!id(relay).state) {
                id(relay).turn_on();
                ESP_LOGI("PRIORITY", "Emergency Heat: Relay ON (priority 2)");
              }
              return;
            }
          }

          // Priority 3: Schedule (Away Mode)
          if (away_mode) {
            if (id(relay).state) {
              id(relay).turn_off();
              ESP_LOGI("PRIORITY", "Schedule: Standby mode - Relay OFF (priority 3)");
            }
            return;
          }

          // Priority 4: Thermostat control
          // ESPHome climate platform handles thermostat control, but we need to handle
          // the case where desired temp < current temp (heating-only system should turn off)
          float current_temp = id(gazebo_temp).state;
          float desired = id(desired_temp).state;
          
          // For heating-only system: if current temp > desired temp, turn off immediately
          // This handles the case where user lowers setpoint below current temperature
          // The climate platform might not handle this immediately due to min_heating_run_time
          if (current_temp > desired) {
            if (id(relay).state) {
              id(relay).turn_off();
              ESP_LOGI("PRIORITY", "Desired temp (%.1f째C) < Current temp (%.1f째C) - Relay OFF (heating-only)",
                       desired, current_temp);
            }
            // Return here - don't let climate platform turn it back on while current > desired
            return;
          }
          
          // When current temp < desired temp, let climate platform control heating
          // The climate platform will evaluate on sensor updates and turn relay on/off
          // We don't interfere here - just let it work
          ESP_LOGD("PRIORITY", "Current (%.1f째C) < Desired (%.1f째C) - Climate platform controls (no interference)",
                   current_temp, desired);
          // Note: Don't return here - let script finish so climate platform can control relay

  # Update relay state (used by manual overrides to trigger priority re-evaluation)
  - id: update_relay_state
    then:
      - script.execute: manage_heating


# ============================================================================
# INTERVAL AUTOMATIONS - Periodic Tasks
# ============================================================================

interval:
  # Check Manual Run timeout every 30 seconds
  - interval: 30s
    then:
      - if:
          condition:
            - lambda: |-
                return id(manual_run_active);
          then:
            - lambda: |-
                long elapsed = millis() - id(manual_run_timeout);
                long timeout_ms = 15 * 60 * 1000; // 15 minutes
                long remaining_ms = timeout_ms - elapsed;
                long remaining_min = remaining_ms / 1000 / 60;
                long remaining_sec = (remaining_ms / 1000) % 60;

                if (elapsed >= timeout_ms) {
                  ESP_LOGI("MANUAL_RUN", "Timeout check: 15 minutes reached - auto-disabling");
                  id(manual_run_active) = false;
                  // Turn off the switch when timeout expires
                  id(manual_run).turn_off();
                } else {
                  ESP_LOGD("MANUAL_RUN", "Timeout check: %ld:%02ld remaining", remaining_min, remaining_sec);
                }
            - script.execute: manage_heating
  
  # Run priority check every 10 seconds to handle cases where desired temp < current temp
  # This ensures heating-only system turns off immediately when setpoint is lowered
  - interval: 10s
    then:
      - script.execute: manage_heating

# ============================================================================
# NOTE: Thermostat Control Architecture
# ============================================================================
# The ESPHome climate platform (thermostat component) handles normal temperature
# control with symmetric hysteresis via heat_deadband and heat_overrun settings.
#
# The manage_heating script applies priority-based overrides on top of the climate
# platform to implement:
#   - Priority 1: Manual Stop (Force Off) blocks all heating
#   - Priority 2: Manual Run (Emergency Heat) for 15 minutes
#   - Priority 3: Away Mode scheduling forces relay off
#   - Priority 4: Climate platform controls heating normally
#
# This multi-tier priority system cannot be replaced by ESPHome's thermostat
# component alone, as it requires application-specific safety logic.
