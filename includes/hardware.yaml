# ============================================================================
# HARDWARE CONFIGURATION
# ============================================================================
# GPIO pins, output drivers, relays, LEDs, one-wire bus

# ============================================================================
# ONE-WIRE BUS CONFIGURATION (GPIO4) - DS18B20 Temperature Sensor
# ============================================================================

one_wire:
  - platform: gpio
    id: ow_bus
    pin: GPIO4

# ============================================================================
# GPIO OUTPUT - Status LED (GPIO2)
# ============================================================================

output:
  - platform: gpio
    id: status_led
    pin: GPIO2
    inverted: true

light:
  - platform: binary
    name: "Status LED"
    output: status_led
    id: status_light

# ============================================================================
# RELAY CONTROL (GPIO12) - Propane Stove Heating Element
# ============================================================================
# Note: Template switches (Manual Run, Manual Stop) are defined in entities.yaml
# Both are combined into a single 'switch:' section in the final config

switch:
  # GPIO Relay for heating element
  - platform: gpio
    name: "Propane Stove Relay"
    id: relay
    pin: GPIO12
    restore_mode: ALWAYS_OFF
    icon: "mdi:fire"
    on_turn_on:
      then:
        - logger.log: "Relay turned ON - Stove heating"
        - light.turn_on: status_light
    on_turn_off:
      then:
        - logger.log: "Relay turned OFF - Stove idle"
        - light.turn_off: status_light

  # Manual Run Override (Emergency heating for 15 minutes)
  - platform: template
    name: "Manual Run"
    id: manual_run
    icon: "mdi:fire-alert"
    restore_mode: ALWAYS_OFF
    optimistic: true
    assumed_state: false
    turn_on_action:
      then:
        - if:
            condition:
              lambda: |-
                // Priority 2: Check if Force Off (Priority 1) is active
                return id(manual_stop_active);
            then:
              # Force Off is active - block Emergency Heat (momentary switch behavior)
              - logger.log: "Emergency Heat blocked by Force Off - switch is momentary only"
              - delay: 100ms  # Brief delay to allow switch state to register
              - lambda: |-
                  id(manual_run).publish_state(false);
            else:
              # Force Off is not active - proceed with Emergency Heat activation
              - logger.log: "Emergency Heat enabled - 15 minute emergency heating"
              - lambda: |-
                  id(manual_run_active) = true;
                  id(relay).turn_on();
                  ESP_LOGI("MANUAL_RUN", "Activated - Relay ON (15-min delay timer started)");
              - script.execute: manual_run_timer  # Start 15-minute delay timer
              - script.execute: manage_heating
    turn_off_action:
      then:
        - logger.log: "Manual Run disabled by user"
        - lambda: |-
            id(manual_run_active) = false;
            // Turn off relay immediately when switch is turned off
            id(relay).turn_off();
            ESP_LOGI("MANUAL_RUN", "Deactivated by user - Relay OFF");
        - script.stop: manual_run_timer  # Stop the timer if still running
        - script.execute: manage_heating

  # Manual Stop Override (Force heating off indefinitely)
  - platform: template
    name: "Manual Stop"
    id: manual_stop
    icon: "mdi:power-off"
    restore_mode: ALWAYS_OFF
    optimistic: true
    assumed_state: false
    turn_on_action:
      then:
        - logger.log: "Force Off enabled - Heating disabled"
        - lambda: |-
            id(manual_stop_active) = true;
            id(relay).turn_off();
            ESP_LOGI("MANUAL_STOP", "Force Off enabled - Relay OFF indefinitely");
        - script.execute: manage_heating
    turn_off_action:
      then:
        - logger.log: "Force Off disabled - Restoring normal control"
        - lambda: |-
            id(manual_stop_active) = false;
            ESP_LOGI("MANUAL_STOP", "Force Off disabled - Normal control resumed");
        - script.execute: manage_heating

  # Heating Schedule Enable/Disable
  - platform: template
    name: "Heating Schedule"
    id: schedule_enabled
    icon: "mdi:calendar-clock"
    restore_mode: ALWAYS_ON
    optimistic: true
    assumed_state: false
    turn_on_action:
      then:
        - logger.log: "Heating schedule enabled"
    turn_off_action:
      then:
        - logger.log: "Heating schedule disabled"
